# 属性编辑

<cite>
**本文档引用文件**  
- [index.vue](file://src/views/index.vue)
- [mixin.js](file://src/views/mixin.js)
</cite>

## 目录
1. [属性栏动态切换机制](#属性栏动态切换机制)  
2. [数据模型定义与映射](#数据模型定义与映射)  
3. [选中事件处理流程](#选中事件处理流程)  
4. [属性保存与更新机制](#属性保存与更新机制)  
5. [响应式更新与重渲染](#响应式更新与重渲染)

## 属性栏动态切换机制

属性栏（detailpannel）根据当前选中对象的类型动态切换显示内容。通过HTML结构中的 `data-status` 属性控制不同状态下的显示逻辑：

- 当选中节点时，`data-status="node-selected"` 的节点属性栏显示
- 当选中边时，`data-status="edge-selected"` 的边属性栏显示
- 群组、画布、多选等状态也通过类似机制管理

该机制依赖G6Editor的Detailpannel组件自动管理状态切换，无需手动控制DOM显示隐藏。

**Section sources**  
- [index.vue](file://src/views/index.vue#L91-L150)

## 数据模型定义与映射

### 节点属性模型
在Vue组件中定义 `nodeAttributeForm` 对象用于管理节点属性：

```js
nodeAttributeForm: {
  label: "",
  width: "",
  height: "",
  color: ""
}
```

该模型与G6数据模型的映射关系如下：
- `label` → G6模型中的文本标签
- `width` 和 `height` → G6模型中 `size` 属性的拆分（格式为 "width*height"）
- `color` → G6模型中的颜色值

### 边属性模型
在Vue组件中定义 `edgeAttributeForm` 对象用于管理边属性：

```js
edgeAttributeForm: {
  label: "",
  shape: ""
}
```

该模型与G6数据模型的映射关系如下：
- `label` → G6模型中的边文本
- `shape` → G6模型中的边形状（如 flow-polyline, flow-smooth 等）

**Section sources**  
- [index.vue](file://src/views/index.vue#L60-L75)

## 选中事件处理流程

通过监听 `afteritemselected` 事件实现属性填充：

```js
currentPage.on("afteritemselected", (ev) => {
  const selectedItemDataModel = ev.item.model;
  if (ev.item.isNode) {
    this.nodeAttributeForm.label = selectedItemDataModel.label;
    this.nodeAttributeForm.width = selectedItemDataModel.size.split("*")[0];
    this.nodeAttributeForm.height = selectedItemDataModel.size.split("*")[1];
    this.nodeAttributeForm.color = selectedItemDataModel.color;
  }
  if (ev.item.isEdge) {
    this.edgeAttributeForm.label = selectedItemDataModel.label;
    this.edgeAttributeForm.shape = selectedItemDataModel.shape;
  }
});
```

处理流程说明：
1. 监听画布的 `afteritemselected` 事件
2. 获取选中项的模型数据（`ev.item.model`）
3. 判断选中对象类型（节点或边）
4. 将G6模型数据解析并填充到对应的Vue表单模型中
5. 触发视图更新，显示相应属性

**Section sources**  
- [index.vue](file://src/views/index.vue#L400-L414)

## 属性保存与更新机制

### 节点属性保存
`saveNodeAttribute` 方法将表单输入同步回画布元素：

```js
saveNodeAttribute() {
  this.editor.executeCommand(() => {
    const page = this.editor.getCurrentPage();
    const selectedItem = page.getSelected()[0];
    page.update(selectedItem.id, {
      label: this.nodeAttributeForm.label,
      size: this.nodeAttributeForm.width + "*" + this.nodeAttributeForm.height,
      color: this.nodeAttributeForm.color
    });
  });
}
```

### 边属性保存
`saveEdgeAttribute` 方法将表单输入同步回画布元素：

```js
saveEdgeAttribute() {
  this.editor.executeCommand(() => {
    const page = this.editor.getCurrentPage();
    const selectedItem = page.getSelected()[0];
    page.update(selectedItem.id, {
      label: this.edgeAttributeForm.label,
      shape: this.edgeAttributeForm.shape
    });
  });
}
```

关键特性：
- 使用 `executeCommand` 包装操作，确保变更进入命令队列，支持撤销/重做
- 通过 `page.update()` 方法更新指定元素
- 获取当前选中元素使用 `page.getSelected()[0]`

**Section sources**  
- [mixin.js](file://src/views/mixin.js#L3-L31)

## 响应式更新与重渲染

结合mixin.js中的通用更新逻辑，形成完整的响应式更新机制：

1. **数据绑定**：Vue的双向绑定确保表单输入实时更新数据模型
2. **命令执行**：`executeCommand` 确保操作可被记录和撤销
3. **模型更新**：`page.update()` 方法修改G6内部数据模型
4. **自动重渲染**：G6Editor监听数据变更，自动触发图形重绘
5. **状态同步**：变更完成后，画布状态与Vue组件状态保持一致

整个流程实现了从用户交互→数据更新→图形重绘的完整闭环，保证了编辑器的响应性和一致性。

**Section sources**  
- [mixin.js](file://src/views/mixin.js#L3-L31)  
- [index.vue](file://src/views/index.vue#L400-L414)