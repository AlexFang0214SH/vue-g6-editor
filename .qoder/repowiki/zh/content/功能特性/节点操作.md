# 节点操作

<cite>
**本文档中引用的文件**  
- [index.vue](file://src/views/index.vue)
- [mixin.js](file://src/views/mixin.js)
- [g6-editor.md](file://doc/v1/g6-editor.md)
</cite>

## 目录
1. [简介](#简介)
2. [节点类型与DOM定义](#节点类型与dom定义)
3. [元素面板与拖拽注入机制](#元素面板与拖拽注入机制)
4. [节点唯一性约束逻辑](#节点唯一性约束逻辑)
5. [用户交互流程](#用户交互流程)
6. [节点数据模型结构与更新机制](#节点数据模型结构与更新机制)
7. [SVG资源引入与自定义节点扩展](#svg资源引入与自定义节点扩展)

## 简介
本节详细说明 `vue-g6-editor` 中节点操作功能的实现机制，涵盖通过元素面板拖拽创建开始节点、常规节点、条件节点和结束节点的完整流程。文档将解析各节点在DOM中的属性定义方式、G6 Editor的Itempannel组件如何实现可视化拖拽注入、节点唯一性约束的事件监听实现，并提供节点创建、选择、删除的交互流程示例，同时说明节点数据模型的结构与更新机制。

## 节点类型与DOM定义
在 `vue-g6-editor` 中，不同类型的节点通过HTML元素的 `data-*` 属性进行定义，这些属性直接映射到G6 Editor的节点数据模型中。

- **开始节点**：使用 `data-shape="flow-circle"` 定义圆形外观，`data-size="72*72"` 设置尺寸，`data-label="开始节点"` 为默认文本，`data-color="#FA8C16"` 指定颜色，并通过 `data-nodeType="startNode"` 标识为开始节点类型。
- **常规节点**：`data-size="100*50"` 定义矩形尺寸，`data-label="常规节点"` 和 `data-color="#1890ff"` 分别设置标签和颜色，未指定 `data-shape` 时默认为矩形。
- **条件节点**：`data-shape="flow-rhombus"` 表示菱形形状，`data-size="80*80"` 设置大小，`data-label="条件节点"` 和 `data-color="#13C2C2"` 配置标签和颜色。
- **结束节点**：与开始节点类似，使用 `data-shape="flow-circle"` 和 `data-size="80*80"`，并通过 `data-nodeType="endNode"` 标识为结束节点。

所有节点元素均包含 `class="getItem"` 和 `data-type="node"`，这是G6 Editor识别可拖拽元素的关键属性。

**Section sources**
- [index.vue](file://src/views/index.vue#L49-L96)

## 元素面板与拖拽注入机制
元素面板通过 `G6Editor.Itempannel` 组件实现，其容器ID为 `itempannel`。面板中的每个节点元素均被赋予 `class="getItem"`，这是G6 Editor识别可拖拽项的必要条件。

拖拽注入机制依赖于 `data-*` 属性的解析：
- `data-type="node"` 告知编辑器该元素为节点类型。
- `data-shape` 指定节点图形形状（如 `flow-circle`、`flow-rhombus`）。
- `data-size` 以“宽*高”格式定义节点在画布上的初始尺寸。
- `data-label` 和 `data-color` 分别设置节点的默认文本和颜色。

当用户从面板拖拽元素至画布时，G6 Editor自动读取这些 `data-*` 属性并生成对应的节点实例。

**Section sources**
- [index.vue](file://src/views/index.vue#L366-L370)
- [g6-editor.md](file://doc/v1/g6-editor.md#L112-L163)

## 节点唯一性约束逻辑
系统通过监听 `afterchange` 事件实现开始节点和结束节点的唯一性约束。当检测到新增节点（`e.action === "add"`）且其类型为 `startNode` 或 `endNode` 时，遍历当前画布上所有节点。

若发现已存在同类型节点（`item.model.nodetype === e.model.nodetype` 且ID不同），则立即调用 `remove(e.item)` 删除新添加的节点，并通过 `this.$message.warning` 提示用户“只能有一个开始节点或结束节点”。

此机制确保了工作流中仅允许存在一个开始节点和一个结束节点，维护了流程图的逻辑完整性。

**Section sources**
- [index.vue](file://src/views/index.vue#L366-L370)

## 用户交互流程
完整的节点操作用户交互流程如下：

1. **创建节点**：用户从左侧元素面板拖拽节点至中央画布，节点根据 `data-*` 属性自动实例化。
2. **选择节点**：点击画布上的节点，触发 `afteritemselected` 事件，属性栏自动填充该节点的 `label`、`size`、`color` 等数据。
3. **修改属性**：在属性栏中修改节点文本、宽高或颜色，输入框的 `@change` 事件调用 `saveNodeAttribute` 方法，通过 `page.update()` 更新节点模型。
4. **删除节点**：选中节点后点击工具栏或右键菜单的“删除”按钮，执行删除操作。

该流程实现了直观、高效的节点管理体验。

**Section sources**
- [index.vue](file://src/views/index.vue#L400-L402)
- [mixin.js](file://src/views/mixin.js#L0-L31)

## 节点数据模型结构与更新机制
节点数据模型包含以下核心字段：
- `label`：节点显示文本。
- `size`：以“宽*高”字符串格式存储节点尺寸。
- `color`：十六进制颜色值，用于节点边框和填充。
- `nodetype`：自定义字段，用于标识节点类型（如 `startNode`、`endNode`）。

更新机制通过 `mixin.js` 中的 `saveNodeAttribute` 方法实现。该方法在 `editor.executeCommand` 事务中调用 `page.update()`，确保属性变更可被撤销/重做。更新时，将表单中的宽度和高度拼接为 `size` 字符串，并同步 `label` 和 `color` 字段。

**Section sources**
- [index.vue](file://src/views/index.vue#L400-L402)
- [mixin.js](file://src/views/mixin.js#L0-L31)

## SVG资源引入与自定义节点扩展
项目通过 `require("../assets/xxx.svg")` 语法在Vue组件中引入本地SVG资源，并绑定到 `img` 标签的 `:src` 属性，确保节点图标正确显示。

对于自定义节点扩展，开发者可在元素面板中添加新的 `div` 元素，设置 `class="getItem"` 和 `data-type="node"`，并配置 `data-shape`、`data-size`、`data-label`、`data-color` 等属性。通过引入不同的SVG图标或使用G6内置形状，可快速扩展支持新类型的节点。

**Section sources**
- [index.vue](file://src/views/index.vue#L23-L51)
- [g6-editor.md](file://doc/v1/g6-editor.md#L112-L163)