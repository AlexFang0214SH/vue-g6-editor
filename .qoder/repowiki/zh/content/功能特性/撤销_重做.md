# 撤销/重做

<cite>
**本文档引用文件**  
- [index.vue](file://src/views/index.vue)
- [Toolbar.vue](file://demo/Toolbar/src/components/Toolbar.vue)
- [g6-editor.md](file://doc/v1/g6-editor.md)
</cite>

## 目录
1. [撤销与重做功能实现机制](#撤销与重做功能实现机制)
2. [工具栏与右键菜单的命令触发方式](#工具栏与右键菜单的命令触发方式)
3. [操作历史栈的自动管理](#操作历史栈的自动管理)
4. [undo/redo命令的默认启用逻辑](#undoredo命令的默认启用逻辑)
5. [重做按钮的UI限制与状态同步问题](#重做按钮的ui限制与状态同步问题)
6. [动态控制重做按钮状态的建议方案](#动态控制重做按钮状态的建议方案)

## 撤销与重做功能实现机制

撤销（undo）与重做（redo）功能是G6 Editor中内置的核心编辑功能，用于管理用户的操作历史。当用户执行可撤销的操作（如添加节点、删除元素、修改属性等）时，这些操作会被记录在操作历史栈中。通过调用`undo`命令，系统会从历史栈中取出最近的操作并执行其反向操作；通过调用`redo`命令，则会重新执行已被撤销的操作。

该机制依赖于G6 Editor的命令系统，每个支持撤销/重做的命令都必须在注册时设置`queue: true`（默认值），以确保操作被加入队列。`undo`和`redo`命令本身也是内置命令，可通过工具栏、右键菜单或快捷键触发。

**Section sources**
- [g6-editor.md](file://doc/v1/g6-editor.md#L810-L850)
- [g6-editor.md](file://doc/v1/g6-editor.md#L852-L919)

## 工具栏与右键菜单的命令触发方式

在G6 Editor中，工具栏和右键菜单中的命令通过HTML元素的`data-command`属性与系统命令绑定。只要元素具有`data-command`属性且其值为有效命令名，同时class包含`command`，即可触发对应命令。

### 工具栏命令触发
工具栏中的撤销和重做按钮通过`i`标签实现，其`data-command`属性分别设置为`undo`和`redo`。例如，在`demo/Toolbar/src/components/Toolbar.vue`中：
```html
<i data-command="undo" class="command fa fa-undo" title="撤销"></i>
<i data-command="redo" class="command fa fa-repeat" title="重做"></i>
```
当用户点击这些图标时，G6 Editor的Toolbar组件会自动识别`data-command`并执行相应命令。

### 右键菜单命令触发
右键菜单根据当前选择状态动态显示不同命令。在画布状态下（`canvas-selected`），右键菜单提供“撤销”和“重做”选项：
```html
<div data-status="canvas-selected" class="menu">
  <el-button data-command="undo" class="command">撤销</el-button>
  <el-button data-command="redo" class="command disable">重做</el-button>
</div>
```
右键菜单由G6 Editor的Contextmenu组件管理，根据当前选择状态自动切换显示的命令组。

**Section sources**
- [Toolbar.vue](file://demo/Toolbar/src/components/Toolbar.vue#L0-L21)
- [index.vue](file://src/views/index.vue#L206-L233)

## 操作历史栈的自动管理

G6 Editor通过其Command系统自动管理操作历史栈。当使用`executeCommand`方法执行一个操作时，该操作及其反向操作（back）会被推入命令队列。系统会自动维护一个栈结构来存储这些可撤销的操作。

例如，在修改节点属性时，代码中通过`executeCommand`包装操作：
```javascript
this.editor.executeCommand(() => {
  page.update(selectedItem.id, {
    label: this.nodeAttributeForm.label,
    size: this.nodeAttributeForm.width + "*" + this.nodeAttributeForm.height,
    color: this.nodeAttributeForm.color
  });
});
```
此操作会被自动记录，用户可通过`undo`命令撤销，通过`redo`命令重做。

命令系统确保了所有通过`executeCommand`执行的操作都具备撤销/重做能力，无需开发者手动管理历史状态。

**Section sources**
- [mixin.js](file://src/views/mixin.js#L0-L32)
- [g6-editor.md](file://doc/v1/g6-editor.md#L417-L446)

## undo/redo命令的默认启用逻辑

`undo`和`redo`命令作为G6 Editor的内置命令，默认情况下已启用并支持快捷键。根据文档，其快捷键配置如下：
- **撤销（undo）**：`Ctrl + Z`（Windows）或 `⌘Z`（Mac）
- **重做（redo）**：`Ctrl + Shift + Z`（Windows）或 `⇧⌘Z`（Mac）

这些命令在Command系统中内置支持，无需额外注册即可使用。任何通过`executeCommand`执行的操作都会自动进入命令队列，从而支持撤销与重做。

此外，自定义命令若希望支持撤销/重做，只需在注册时设置`queue: true`（默认值），系统会自动处理其入队和出队逻辑。

**Section sources**
- [g6-editor.md](file://doc/v1/g6-editor.md#L920-L945)
- [g6-editor.md](file://doc/v1/g6-editor.md#L852-L919)

## 重做按钮的UI限制与状态同步问题

当前实现中存在一个UI限制：在画布状态下，右键菜单中的“重做”按钮被静态设置为`disable`类，导致其始终处于禁用状态，即使存在可重做的操作。

```html
<el-button data-command="redo" class="command disable">重做</el-button>
```

此问题源于状态同步机制的缺失。虽然G6 Editor提供了`aftercommandexecute`和`afterback`等事件用于监听命令执行状态，但当前UI并未利用这些事件动态更新“重做”按钮的可用状态。因此，按钮的启用/禁用状态未能与实际的命令栈状态保持同步，影响了用户体验。

**Section sources**
- [index.vue](file://src/views/index.vue#L206-L233)
- [g6-editor.md](file://doc/v1/g6-editor.md#L660-L696)

## 动态控制重做按钮状态的建议方案

为解决重做按钮的状态同步问题，建议通过监听G6 Editor提供的事件来动态控制按钮的可用状态。具体方案如下：

1. **监听命令执行事件**：使用`aftercommandexecute`事件监听任何命令执行后的状态。
2. **监听撤销/重做事件**：使用`afterback`事件专门监听撤销操作的完成。
3. **动态更新UI状态**：在事件回调中检查当前是否可执行`redo`命令，并相应地移除或添加`disable`类。

示例代码逻辑：
```javascript
const currentPage = editor.getCurrentPage();
currentPage.on('aftercommandexecute', (e) => {
  // 命令执行后，重做栈可能被清空，禁用重做按钮
  updateRedoButtonState(false);
});

currentPage.on('afterback', (e) => {
  // 撤销操作后，检查是否可重做，启用重做按钮
  const canRedo = editor.getCommandStack().canRedo();
  updateRedoButtonState(canRedo);
});
```

通过此方案，可实现重做按钮状态与操作历史栈的实时同步，提供更完善的用户体验。

**Section sources**
- [g6-editor.md](file://doc/v1/g6-editor.md#L662)
- [index.vue](file://src/views/index.vue#L206-L233)