# 自定义节点

<cite>
**本文档引用文件**  
- [index.vue](file://src/views/index.vue)
- [mixin.js](file://src/views/mixin.js)
- [g6-editor.md](file://doc/v1/g6-editor.md)
</cite>

## 目录
1. [自定义节点注册机制](#自定义节点注册机制)
2. [节点属性绑定机制](#节点属性绑定机制)
3. [Vue组件中封装SVG绘制逻辑](#vue组件中封装svg绘制逻辑)
4. [节点状态样式与交互行为配置](#节点状态样式与交互行为配置)
5. [mixin复用属性更新逻辑](#mixin复用属性更新逻辑)
6. [常见问题排查方案](#常见问题排查方案)

## 自定义节点注册机制

在G6中，通过`G6.registerNode`方法注册自定义节点类型。该方法允许开发者定义节点的形状、绘制逻辑、状态样式及交互行为。在本项目中，虽然未直接调用`registerNode`，但通过预设的`data-shape`属性（如`flow-circle`、`flow-rhombus`）间接使用了G6内置的节点类型。

在`src/views/index.vue`中，通过`data-shape`属性指定节点形状，如开始节点和结束节点使用`flow-circle`，条件节点使用`flow-rhombus`。这些形状名称对应G6内部注册的节点类型，开发者可通过查阅G6源码或文档了解其具体实现。

**Section sources**
- [index.vue](file://src/views/index.vue#L49-L96)

## 节点属性绑定机制

节点的外观和行为通过HTML元素上的`data-*`属性进行绑定。这些属性在拖拽到画布时被自动解析并应用到节点模型中。

- `data-type="node"`：指定元素类型为节点，是G6识别可拖拽元素的关键。
- `data-shape`：定义节点形状，如`flow-circle`表示圆形节点。
- `data-size`：以“宽*高”格式定义节点尺寸，如`72*72`。
- `data-label`：设置节点文本标签。
- `data-color`：指定节点颜色。
- `data-nodeType`：自定义业务类型标识，用于逻辑控制。

这些属性在`index.vue`的元素面板中定义，当用户拖拽节点到画布时，G6自动读取这些`data-*`属性并生成对应的节点实例。

**Section sources**
- [index.vue](file://src/views/index.vue#L23-L51)

## Vue组件中封装SVG绘制逻辑

在Vue组件中，通过`<img>`标签引用SVG文件实现节点图形的可视化。SVG文件存储在`src/assets/`目录下，包括`start-node.svg`、`end-node.svg`、`regular-node.svg`和`condition-node.svg`。

在`index.vue`中，通过`require`引入SVG资源并绑定到`<img>`标签的`src`属性。同时设置`draggable="false"`防止SVG自身被拖拽，确保拖拽行为由父级`div`控制。

SVG图形的尺寸和颜色可通过外部属性控制。例如，`data-size`控制节点整体尺寸，`data-color`影响SVG中的描边和填充色。这种设计实现了图形与样式的分离，便于动态更新。

**Section sources**
- [index.vue](file://src/views/index.vue#L127-L150)
- [start-node.svg](file://src/assets/start-node.svg)
- [condition-node.svg](file://src/assets/condition-node.svg)

## 节点状态样式与交互行为配置

节点的状态样式（点击、悬停、选中）由G6内部机制自动管理。当节点被选中时，`afteritemselected`事件触发，此时可更新属性面板显示当前节点属性。

在`index.vue`中，通过监听`currentPage.on("afteritemselected")`事件获取选中节点的数据模型，并将其`label`、`size`、`color`等属性填充到`nodeAttributeForm`表单中。用户修改表单值后，通过`saveNodeAttribute`方法调用`page.update`更新节点属性，实现动态外观更新。

对于交互行为，如点击、悬停等，G6提供了默认的视觉反馈。开发者可通过CSS或G6的样式配置进一步定制这些状态的外观。

**Section sources**
- [index.vue](file://src/views/index.vue#L366-L402)

## mixin复用属性更新逻辑

为避免重复代码，项目使用mixin机制复用属性更新逻辑。在`mixin.js`中定义了`saveNodeAttribute`和`saveEdgeAttribute`方法，分别用于保存节点和边的属性变更。

`saveNodeAttribute`方法通过`editor.executeCommand`执行更新命令，确保操作可撤销。它获取当前页面和选中节点，调用`page.update`方法更新节点的`label`、`size`和`color`属性。`size`属性需将宽度和高度拼接为“宽*高”格式。

这种设计将属性更新逻辑集中管理，提高了代码的可维护性和一致性。其他组件可通过引入该mixin快速获得属性更新能力。

**Section sources**
- [mixin.js](file://src/views/mixin.js#L2-L32)

## 常见问题排查方案

### 节点拖拽失效
- 检查元素`class`是否包含`getItem`，这是G6识别可拖拽元素的必要条件。
- 确认`data-type="node"`已正确设置。
- 检查`draggable="false"`是否应用于`<img>`标签，防止内部元素干扰拖拽。

### 样式未生效
- 验证`data-*`属性拼写是否正确，特别是`data-shape`和`data-size`。
- 确保SVG文件路径正确，且文件可正常加载。
- 检查G6的`registerNode`是否已正确注册自定义形状。

### 事件绑定失败
- 确认事件监听器在`currentPage`实例化后添加。
- 检查事件名称是否正确，如`afteritemselected`而非`itemselected`。
- 验证`editor`和`currentPage`实例是否已正确初始化并挂载。

通过以上方案，可系统性地排查和解决自定义节点开发中的常见问题。

**Section sources**
- [index.vue](file://src/views/index.vue#L320-L370)
- [g6-editor.md](file://doc/v1/g6-editor.md#L112-L163)