# 命令系统

<cite>
**本文档中引用的文件**  
- [index.vue](file://src/views/index.vue)
- [mixin.js](file://src/views/mixin.js)
- [Toolbar.vue](file://demo/Toolbar/src/components/Toolbar.vue)
- [g6-editor.md](file://doc/v1/g6-editor.md)
</cite>

## 目录
1. [简介](#简介)
2. [命令注册机制](#命令注册机制)
3. [命令对象方法解析](#命令对象方法解析)
4. [DOM元素与命令绑定](#dom元素与命令绑定)
5. [自定义命令扩展示例](#自定义命令扩展示例)
6. [撤销/重做机制](#撤销/重做机制)
7. [命令与事件系统协同](#命令与事件系统协同)
8. [常见陷阱与解决方案](#常见陷阱与解决方案)
9. [结论](#结论)

## 简介
本文件深入讲解基于 G6 Editor Command API 的命令扩展机制。G6 Editor 是一个功能强大的图编辑框架，其命令系统是实现用户交互、状态管理与操作可逆性的核心模块。通过 `Command.registerCommand` 可以注册自定义命令，并将其绑定至工具栏按钮或快捷键，从而实现声明式操作控制。本文档将详细解析命令系统的执行逻辑、事务管理机制及其在实际项目中的应用方式。

## 命令注册机制
G6 Editor 提供了 `Command.registerCommand` 方法用于注册自定义或重载内置命令。该方法接受命令名称和命令对象作为参数，命令对象定义了命令的行为逻辑。

命令注册通常在编辑器初始化阶段完成。例如，在 `index.vue` 文件中，通过 `G6Editor.Command` 注册了一个名为 `save` 的自定义命令：

```javascript
const Command = G6Editor.Command;
Command.registerCommand("save", { ... });
```

注册后，该命令即可通过工具栏按钮、右键菜单或快捷键触发。命令是否进入命令队列由 `queue` 属性控制，默认为 `true`，表示可撤销/重做；若设为 `false`，则不参与事务管理。

**Section sources**
- [index.vue](file://src/views/index.vue#L274-L324)

## 命令对象方法解析
每个注册的命令对象包含多个关键方法，用于定义其行为逻辑与执行流程。

### execute 方法
`execute` 是命令的正向执行方法，包含实际的业务逻辑。例如，`save` 命令在 `execute` 中调用 `editor.getCurrentPage().save()` 获取当前画布数据，并将其保存至本地存储。

### back 方法
`back` 是反向命令，用于撤销 `execute` 的操作。对于不可逆操作（如保存），`back` 可为空或仅作日志记录。

### canExecute / enable 方法
`enable` 方法决定命令是否可用。它接收 `editor` 实例作为参数，返回布尔值。例如，可根据当前选中对象类型动态启用/禁用命令。

### shortcutCodes 属性
`shortcutCodes` 定义快捷键组合。支持多组快捷键配置，如 `["ctrlKey", "s"]` 和 `["metaKey", "s"]` 分别对应 Windows 与 Mac 的 Ctrl+S 和 Cmd+S。

值得注意的是，即使设置了 `shortcutCodes`，默认情况下快捷键不会生效，必须在初始化 `Flow` 或 `MindMap` 时显式开启：

```javascript
const flow = new G6Editor.Flow({
  shortcut: {
    save: true
  }
});
```

**Section sources**
- [index.vue](file://src/views/index.vue#L274-L324)
- [g6-editor.md](file://doc/v1/g6-editor.md#L852-L919)

## DOM元素与命令绑定
G6 Editor 使用 `data-command` 属性将 DOM 元素与命令进行声明式绑定。任何带有 `data-command` 属性且 `class` 包含 `command` 的元素，点击时将自动触发对应命令。

### 工具栏绑定
在工具栏中，每个 `<i>` 标签通过 `data-command` 绑定命令：

```html
<i data-command="save" class="command fa fa-floppy-o" title="保存"></i>
```

只要命令已注册，点击该图标即可执行 `save` 命令。

### 右键菜单绑定
右键菜单同样使用 `data-command` 实现命令绑定：

```html
<el-button data-command="copy" class="command">复制</el-button>
```

菜单的显示状态由 `data-status` 控制，G6 Editor 会根据当前选中对象类型自动切换菜单状态（如 `node-selected`、`edge-selected` 等）。

### 绑定规范
- 必须设置 `data-command` 属性，值为已注册的命令名
- `class` 中必须包含 `command` 类
- 支持 `<i>`、`<button>`、`<div>` 等多种元素类型

**Section sources**
- [index.vue](file://src/views/index.vue#L0-L23)
- [Toolbar.vue](file://demo/Toolbar/src/components/Toolbar.vue#L0-L21)
- [g6-editor.md](file://doc/v1/g6-editor.md#L48-L61)

## 自定义命令扩展示例
以下是一个完整的自定义命令扩展示例，涵盖参数传递、状态检查与错误处理。

### 注册 align 命令
```javascript
Command.registerCommand("align", {
  queue: true,
  enable(editor) {
    const selected = editor.getCurrentPage().getSelected();
    return selected.length > 1; // 至少选中两个元素才可对齐
  },
  execute(editor, direction) {
    if (!direction) {
      console.error("对齐方向未指定");
      return;
    }
    const nodes = editor.getCurrentPage().getSelectedNodes();
    // 实现左对齐、右对齐、居中等逻辑
    const firstNode = nodes[0];
    nodes.forEach(node => {
      if (node !== firstNode) {
        editor.getCurrentPage().update(node.id, {
          x: direction === 'left' ? firstNode.x : 
             direction === 'right' ? firstNode.x + firstNode.width - node.width :
             firstNode.x + (firstNode.width - node.width) / 2
        });
      }
    });
  },
  back(editor) {
    // 撤销操作由 G6 Editor 自动管理
  }
});
```

### 绑定至工具栏
```html
<i data-command="align" data-args="left" class="command" title="左对齐">⬅️</i>
<i data-command="align" data-args="center" class="command" title="居中对齐">⬌</i>
<i data-command="align" data-args="right" class="command" title="右对齐">➡️</i>
```

通过 `data-args` 可传递参数至命令执行方法。

**Section sources**
- [index.vue](file://src/views/index.vue#L274-L324)
- [g6-editor.md](file://doc/v1/g6-editor.md#L852-L919)

## 撤销/重做机制
命令系统是实现撤销/重做功能的核心。所有 `queue: true` 的命令执行后会被推入命令栈，支持通过 `undo` 和 `redo` 命令进行回退。

### 命令栈管理
- `execute` 执行正向操作
- `back` 定义反向操作（可选，若未定义则由系统自动推导）
- 每次 `execute` 后，`redo` 栈清空
- `undo` 执行 `back`，`redo` 重新执行 `execute`

### 内置撤销/重做命令
G6 Editor 提供了内置的 `undo` 和 `redo` 命令，并支持快捷键：
- `undo`: Ctrl+Z (Win) / ⌘Z (Mac)
- `redo`: Ctrl+Shift+Z (Win) / ⇧⌘Z (Mac)

这些命令通过监听 `aftercommandexecute` 事件自动更新 UI 状态（如禁用 `redo` 按钮）。

**Section sources**
- [index.vue](file://src/views/index.vue#L0-L23)
- [g6-editor.md](file://doc/v1/g6-editor.md#L920-L945)

## 命令与事件系统协同
命令系统与 G6 Editor 的事件系统紧密协作，实现状态同步与副作用管理。

### 关键事件
- `beforecommandexecute`: 命令执行前，可用于拦截或验证
- `aftercommandexecute`: 命令执行后，可用于更新 UI 或日志记录
- `afterchange`: 画布变更后，可用于自动保存或状态检查

例如，在 `index.vue` 中监听 `afterchange` 事件，限制只能有一个开始节点或结束节点：

```javascript
currentPage.on("afterchange", (e) => {
  if (e.action === "add") {
    if (e.model.nodetype === "startNode" || e.model.nodetype === "endNode") {
      // 检查并移除重复节点
    }
  }
});
```

**Section sources**
- [index.vue](file://src/views/index.vue#L366-L402)
- [g6-editor.md](file://doc/v1/g6-editor.md#L660-L696)

## 常见陷阱与解决方案
### 命令未注册导致按钮失效
**问题**：点击工具栏按钮无响应  
**原因**：命令未通过 `Command.registerCommand` 注册  
**解决方案**：确保在初始化编辑器后立即注册所有自定义命令

### 异步操作破坏命令栈一致性
**问题**：在 `execute` 中执行异步操作（如 API 调用），导致 `back` 无法正确撤销  
**解决方案**：
1. 将异步操作结果视为新状态，`execute` 中仅提交已知结果
2. 或使用 `executeCommand` 包装异步逻辑，确保事务完整性

```javascript
execute(editor) {
  this.editor.executeCommand(() => {
    // 同步更新 UI 状态
    // 异步保存至服务器
    saveToServer().catch(err => {
      this.$message.error("保存失败");
    });
  });
}
```

### 快捷键不生效
**问题**：设置了 `shortcutCodes` 但快捷键无效  
**原因**：未在 `Flow` 配置中启用快捷键  
**解决方案**：在初始化 `Flow` 时设置 `shortcut: { commandName: true }`

**Section sources**
- [index.vue](file://src/views/index.vue#L320-L370)
- [g6-editor.md](file://doc/v1/g6-editor.md#L852-L919)

## 结论
G6 Editor 的命令系统提供了一套强大而灵活的机制，用于管理用户操作、实现撤销/重做功能，并通过声明式绑定简化 UI 集成。通过 `Command.registerCommand` 可轻松扩展自定义命令，结合 `data-command` 属性实现工具栏与右键菜单的自动化控制。合理利用 `execute`、`back`、`enable` 等方法，可构建出健壮、可维护的图编辑应用。同时，需注意避免异步操作破坏事务一致性，并正确配置快捷键以提升用户体验。